<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MIDI Footswitch Config</title>

<style>
:root{--bg:#0f1115;--panel:#171a21;--muted:#7b8191;--text:#e8eaf1;--accent:#6ec2ff;--danger:#ff6b6b;--ok:#65d48c;--border:#262a34;--input:#1e2330;font-family:ui-sans-serif,system-ui}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text)}
.app{max-width:1100px;margin:24px auto;padding:0 16px}
header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
h1{margin:0;font-size:22px}
button,select,input{background:var(--input);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
button{cursor:pointer}
button:disabled{opacity:.5}
section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin:16px 0}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
th{color:var(--muted)}
.pad{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.pbtn{display:flex;justify-content:space-between;align-items:center;background:#141823;border:1px solid var(--border);border-radius:12px;padding:12px}
.led{width:16px;height:16px;border-radius:50%;background:#222;border:1px solid var(--border)}
.led.on{background:var(--ok);box-shadow:0 0 8px var(--ok)}
.monitor{background:#0e1320;border:1px solid var(--border);border-radius:8px;padding:8px;font-family:monospace;font-size:12px;max-height:200px;overflow:auto}
.learn-on{outline:2px solid var(--accent)}
.small{font-size:12px;color:var(--muted)}
.badge{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#121826;font-size:12px;color:var(--text)}
.danger{background:#2a171b;color:#ffb2b2;border-color:#44252b}
</style>
</head>

<body>
<div class="app">

<header>
  <h1>MIDI Footswitch Config</h1>
  <div>
    <button id="enableMidi">Enable MIDI</button>
    <select id="midiInputs" disabled></select>
    <select id="midiOutputs" disabled></select>
  </div>
</header>

<section>
  <label>Preset Name
    <input id="presetName" placeholder="My preset">
  </label>
  <div style="margin-top:8px">
    <button id="savePreset">Save</button>
    <button id="loadPreset">Load</button>
    <button id="downloadPreset">Export JSON</button>
    <input id="uploadPreset" type="file" accept="application/json" hidden>
    <button id="uploadPresetBtn">Import JSON</button>
    <span id="learnStatus" class="badge">Learn: off</span>
  </div>
</section>

<section>
  <table>
    <thead>
      <tr>
        <th>#</th><th>Label</th><th>Type</th><th>Ch</th><th>PC/CC#</th><th>Value</th><th>Mode</th><th>LED</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div style="margin-top:10px">
    <button id="addRow">+ Add</button>
    <button id="clearRows" class="danger">Clear All</button>
  </div>
</section>

<section>
  <h3>Virtual Buttons</h3>
  <div id="pad" class="pad"></div>
</section>

<section>
  <h3>MIDI Monitor</h3>
  <div id="monitor" class="monitor"></div>
</section>

</div>

<script>
const $ = s=>document.querySelector(s);
const state = {
  midi:{access:null,ins:[],outs:[],in:null,out:null},
  rows:[],
  presetName:"Default",
  learnRowId:null
};

const els = {
  enable:$('#enableMidi'), ins:$('#midiInputs'), outs:$('#midiOutputs'),
  status:$('#status'), rows:$('#rows'), pad:$('#pad'), monitor:$('#monitor'),
  presetName:$('#presetName'), savePreset:$('#savePreset'),
  loadPreset:$('#loadPreset'), downloadPreset:$('#downloadPreset'),
  uploadPresetBtn:$('#uploadPresetBtn'), uploadPreset:$('#uploadPreset'),
  addRow:$('#addRow'), clearRows:$('#clearRows'), learnStatus:$('#learnStatus')
};

function escapeHTML(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

// MIDI enable
async function enableMIDI(){
  if(!("requestMIDIAccess" in navigator)){alert("WebMIDI unsupported");return;}
  const access=await navigator.requestMIDIAccess({sysex:false});
  state.midi.access=access;
  refreshPorts();
}

function refreshPorts(){
  state.midi.ins = [...state.midi.access.inputs.values()];
  state.midi.outs = [...state.midi.access.outputs.values()];
  els.ins.innerHTML = state.midi.ins.map((i,idx)=>`<option value="${idx}">${i.name}</option>`).join('');
  els.outs.innerHTML = state.midi.outs.map((o,idx)=>`<option value="${idx}">${o.name}</option>`).join('');
  els.ins.disabled = state.midi.ins.length===0;
  els.outs.disabled = state.midi.outs.length===0;
  if(state.midi.ins[0]){
    state.midi.in = state.midi.ins[0];
    state.midi.in.onmidimessage = onMidiIn;
  }
  if(state.midi.outs[0]) state.midi.out = state.midi.outs[0];
}

function onMidiIn(e){
  const [s,d1=0,d2=0]=e.data;
  const hi=s&0xF0, ch=(s&0x0F)+1;
  let msg="";
  if(hi===0xC0){ msg=`PC ch${ch} prog=${d1}`; handleLearn("PC",ch,d1,0); }
  else if(hi===0xB0){ msg=`CC ch${ch} #${d1} v=${d2}`; handleLearn("CC",ch,d1,d2); }
  else msg=`${e.data}`;
  log(msg);
}

function log(t){
  const div=document.createElement("div");
  div.textContent=t;
  els.monitor.prepend(div);
  while(els.monitor.children.length>80) els.monitor.removeChild(els.monitor.lastChild);
}

function sendPC(ch,p){ if(state.midi.out) state.midi.out.send([0xC0|(ch-1),p]); }
function sendCC(ch,cc,v){ if(state.midi.out) state.midi.out.send([0xB0|(ch-1),cc,v]); }

// rows
function addRow(r=null){
  if(!r){
    r={id:crypto.randomUUID(),index:state.rows.length+1,label:`FS ${state.rows.length+1}`,type:"PC",channel:1,number:0,value:127,mode:"toggle",led:false};
  }
  state.rows.push(r);
  renderRows(); renderPad();
}

function deleteRow(id){
  state.rows=state.rows.filter(r=>r.id!==id);
  state.rows.forEach((r,i)=>r.index=i+1);
  renderRows(); renderPad();
}

function setLearn(id){
  state.learnRowId=id;
  els.learnStatus.textContent=id?`Learn: row ${getRow(id).index}`:"Learn: off";
  renderRows();
}

function getRow(id){return state.rows.find(r=>r.id===id);}

function handleLearn(type,ch,num,val){
  if(!state.learnRowId) return;
  const r=getRow(state.learnRowId);
  if(!r)return;
  r.type=type; r.channel=ch; r.number=num;
  if(type==="CC") r.value=val;
  setLearn(null);
  renderRows(); renderPad();
}

function updateField(id,key,val){
  const r=getRow(id); if(!r)return;
  if(key==="channel") r.channel=Math.max(1,Math.min(16,parseInt(val)));
  else if(key==="number"||key==="value") r[key]=Math.max(0,Math.min(127,parseInt(val)));
  else r[key]=val;
  renderPad();
}

// render table
function renderRows(){
  els.rows.innerHTML=state.rows.map(r=>`
<tr data-id="${r.id}" class="${state.learnRowId===r.id?'learn-on':''}">
  <td>${r.index}</td>
  <td><input data-k="label" value="${escapeHTML(r.label)}"></td>
  <td>
    <select data-k="type">
      <option ${r.type==='PC'?'selected':''}>PC</option>
      <option ${r.type==='CC'?'selected':''}>CC</option>
    </select>
  </td>
  <td><input type="number" data-k="channel" value="${r.channel}"></td>
  <td><input type="number" data-k="number" value="${r.number}"></td>
  <td><input type="number" data-k="value" value="${r.value}" ${r.type==='PC'?'disabled':''}></td>
  <td>
    <select data-k="mode">
      <option value="toggle" ${r.mode==='toggle'?'selected':''}>Toggle</option>
      <option value="momentary" ${r.mode==='momentary'?'selected':''}>Momentary</option>
    </select>
  </td>
  <td>${r.led?'On':'Off'}</td>
  <td>
    <button class="learn">Learn</button>
    <button class="test">Send</button>
    <button class="del">Del</button>
  </td>
</tr>`).join("");

  els.rows.querySelectorAll("input,select").forEach(el=>{
    el.onchange=()=>{
      const id=el.closest("tr").dataset.id;
      updateField(id,el.dataset.k,el.value);
    };
  });
  els.rows.querySelectorAll(".del").forEach(b=>{
    b.onclick=()=>deleteRow(b.closest("tr").dataset.id);
  });
  els.rows.querySelectorAll(".test").forEach(b=>{
    b.onclick=()=>{
      const r=getRow(b.closest("tr").dataset.id);
      if(r.type==="PC") sendPC(r.channel,r.number);
      else sendCC(r.channel,r.number,r.value);
    };
  });
  els.rows.querySelectorAll(".learn").forEach(b=>{
    b.onclick=()=>{
      const id=b.closest("tr").dataset.id;
      setLearn(state.learnRowId===id?null:id);
    };
  });
}

// virtual pad
function renderPad(){
  els.pad.innerHTML=state.rows.map(r=>`
<div class="pbtn" data-id="${r.id}">
  <div>
    <div><b>${escapeHTML(r.label)}</b></div>
    <div class="small">${r.type} Ch${r.channel} #${r.number}</div>
  </div>
  <div class="led ${r.led?'on':''}"></div>
  <button class="tap">Tap</button>
</div>`).join("");

  els.pad.querySelectorAll(".tap").forEach(btn=>{
    const id=btn.closest(".pbtn").dataset.id;
    btn.onmousedown=()=>press(id);
    btn.onmouseup=()=>release(id);
    btn.ontouchstart=e=>{e.preventDefault();press(id);};
    btn.ontouchend=e=>{e.preventDefault();release(id);};
  });
}

function press(id){
  const r=getRow(id);
  if(r.type==="PC"){
    sendPC(r.channel,r.number);
    r.led=true; renderPad();
    setTimeout(()=>{r.led=false; renderPad();},120);
    return;
  }
  if(r.mode==="momentary"){
    sendCC(r.channel,r.number,r.value);
    r.led=true; renderPad();
  } else {
    r.led=!r.led;
    sendCC(r.channel,r.number,r.led?r.value:0);
    renderPad();
  }
}

function release(id){
  const r=getRow(id);
  if(r.type==="CC" && r.mode==="momentary"){
    sendCC(r.channel,r.number,0);
    r.led=false; renderPad();
  }
}

// presets
const LS="midi-config-v1";
function saveLS(){localStorage.setItem(LS,JSON.stringify({name:state.presetName,rows:state.rows}));}
function loadLS(){
  const s=localStorage.getItem(LS);
  if(!s) return false;
  try{
    const j=JSON.parse(s);
    state.presetName=j.name;
    state.rows=j.rows;
    els.presetName.value=j.name;
    renderRows();renderPad();
    return true;
  }catch{return false;}
}

document.addEventListener("DOMContentLoaded",()=>{
  if(!loadLS()){
    addRow(); addRow(); addRow();
  }
  renderRows(); renderPad();

  els.enable.onclick=enableMIDI;
  els.ins.onchange=()=>{state.midi.in=state.midi.ins[els.ins.value];state.midi.in.onmidimessage=onMidiIn;};
  els.outs.onchange=()=>{state.midi.out=state.midi.outs[els.outs.value];};

  els.addRow.onclick=()=>addRow();
  els.clearRows.onclick=()=>{if(confirm("Clear all?")){state.rows=[];renderRows();renderPad();saveLS();}};

  els.presetName.oninput=e=>{state.presetName=e.target.value;saveLS();};
  els.savePreset.onclick=()=>saveLS();
  els.loadPreset.onclick=()=>loadLS();

  els.downloadPreset.onclick=()=>{
    const data=JSON.stringify({name:state.presetName,rows:state.rows},null,2);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([data],{type:"application/json"}));
    a.download=(state.presetName||"preset")+".json";
    a.click();
  };

  els.uploadPresetBtn.onclick=()=>els.uploadPreset.click();
  els.uploadPreset.onchange=async()=>{
    const f=els.uploadPreset.files[0];
    if(f){
      const t=await f.text();
      loadLS(t);
    }
  };
});
</script>

</body>
</html>
